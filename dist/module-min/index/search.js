import{SearchOptions}from"../type.js";import{create_object,is_object,sort_by_length_down}from"../common.js";import Index from"../index.js";import default_compress from"../compress.js";import Resolver from"../resolver.js";import{intersect}from"../intersect.js";import resolve_default from"../resolve/default.js";let global_resolve=1;export function set_resolve(a){global_resolve=a}Index.prototype.search=function(a,b,c){c||(!b&&is_object(a)?(c=a,a=""):is_object(b)&&(c=b,b=0));let d,e,f,g,h,i,j,k=[],l=0;if(c?(a=c.query||a,b=c.limit||b,l=c.offset||0,e=c.context,f=c.suggest,g=global_resolve&&!1!==c.resolve,g||(global_resolve=0),h=g&&c.enrich,j=c.boost,i=this.db&&c.tag):g=this.resolve||global_resolve,a=this.encoder.encode(a),d=a.length,b||!g||(b=100),1===d)return single_term_query.call(this,a[0],"",b,l,g,h,i);if(e=this.depth&&!1!==e,2===d&&e&&!f)return single_term_query.call(this,a[0],a[1],b,l,g,h,i);let m=0,n=0;if(1<d){const b=create_object(),c=[];for(let e,h=0;h<d;h++)if(e=a[h],e&&!b[e]){if(!f&&!this.db&&!this.get_array(e))return g?k:new Resolver(k);c.push(e),b[e]=1;const a=e.length;m=Math.max(m,a),n=n?Math.min(n,a):a}a=c,d=a.length}if(!d)return g?k:new Resolver(k);let o,p=0;if(1===d)return single_term_query.call(this,a[0],"",b,l,g,h,i);if(2===d&&e&&!f)return single_term_query.call(this,a[0],a[1],b,l,g,h,i);if(1<d&&(e?(o=a[0],p=1):9<m&&3<m/n&&a.sort(sort_by_length_down)),this.db){if(this.db.search){const c=this.db.search(this,a,b,l,f,g,h,i);if(!1!==c)return c}const c=this;return async function(){for(let e,h;p<d;p++){if(h=a[p],o?(e=await c.get_array(h,o,0,0,!1,!1),e=add_result(e,k,f,c.resolution_ctx),(!f||!1!==e||!k.length)&&(o=h)):(e=await c.get_array(h,"",0,0,!1,!1),e=add_result(e,k,f,c.resolution)),e)return e;if(f&&p==d-1){let a=k.length;if(!a){if(o){o="",p=-1;continue}return k}if(1===a)return g?resolve_default(k[0],b,l):new Resolver(k[0])}}return g?intersect(k,c.resolution,b,l,f,j,g):new Resolver(k[0])}()}for(let e,h;p<d;p++){if(h=a[p],o?(e=this.get_array(h,o,0,0,!1,!1),e=add_result(e,k,f,this.resolution_ctx),(!f||!1!==e||!k.length)&&(o=h)):(e=this.get_array(h,"",0,0,!1,!1),e=add_result(e,k,f,this.resolution)),e)return e;if(f&&p==d-1){const a=k.length;if(!a){if(o){o="",p=-1;continue}return k}if(1===a)return g?resolve_default(k[0],b,l):new Resolver(k[0])}}return k=intersect(k,this.resolution,b,l,f,j,g),g?k:new Resolver(k)};function single_term_query(a,b,c,d,e,f,g){const h=this.get_array(a,b,c,d,e,f,g);return this.db?h.then(function(a){return e?a:a&&a.length?e?resolve_default(a,c,d):new Resolver(a):e?[]:new Resolver([])}):h&&h.length?e?resolve_default(h,c,d):new Resolver(h):e?[]:new Resolver([])}function add_result(a,b,c,d){let e=[];if(a){d=Math.min(a.length,d);for(let b,c=0;c<d;c++)(b=a[c])&&b&&(e[c]=b);if(e.length)return void b.push(e)}return!c&&e}Index.prototype.get_array=function(a,b,c,d,e,f,g){let h,i;return(b&&(i=this.bidirectional&&a>b),this.compress&&(a=default_compress(a),b&&(b=default_compress(b))),this.db)?b?this.db.get(i?b:a,i?a:b,c,d,e,f,g):this.db.get(a,"",c,d,e,f,g):(b?(h=this.ctx.get(i?a:b),h=h&&h.get(i?b:a)):h=this.map.get(a),h)};