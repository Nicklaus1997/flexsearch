import{parse_option}from"./common.js";const whitespace=/[^\p{L}\p{N}]+/u,numeric_split_length=/(\d{3})/g,numeric_split_prev_char=/(\D)(\d{3})/g,numeric_split_next_char=/(\d{3})(\D)/g,normalize=/[\u0300-\u036f]/g,normalize_mapper=!normalize&&[["\xAA","a"],["\xB2","2"],["\xB3","3"],["\xB9","1"],["\xBA","o"],["\xBC","1\u20444"],["\xBD","1\u20442"],["\xBE","3\u20444"],["\xE0","a"],["\xE1","a"],["\xE2","a"],["\xE3","a"],["\xE4","a"],["\xE5","a"],["\xE7","c"],["\xE8","e"],["\xE9","e"],["\xEA","e"],["\xEB","e"],["\xEC","i"],["\xED","i"],["\xEE","i"],["\xEF","i"],["\xF1","n"],["\xF2","o"],["\xF3","o"],["\xF4","o"],["\xF5","o"],["\xF6","o"],["\xF9","u"],["\xFA","u"],["\xFB","u"],["\xFC","u"],["\xFD","y"],["\xFF","y"],["\u0101","a"],["\u0103","a"],["\u0105","a"],["\u0107","c"],["\u0109","c"],["\u010B","c"],["\u010D","c"],["\u010F","d"],["\u0113","e"],["\u0115","e"],["\u0117","e"],["\u0119","e"],["\u011B","e"],["\u011D","g"],["\u011F","g"],["\u0121","g"],["\u0123","g"],["\u0125","h"],["\u0129","i"],["\u012B","i"],["\u012D","i"],["\u012F","i"],["\u0133","ij"],["\u0135","j"],["\u0137","k"],["\u013A","l"],["\u013C","l"],["\u013E","l"],["\u0140","l"],["\u0144","n"],["\u0146","n"],["\u0148","n"],["\u0149","n"],["\u014D","o"],["\u014F","o"],["\u0151","o"],["\u0155","r"],["\u0157","r"],["\u0159","r"],["\u015B","s"],["\u015D","s"],["\u015F","s"],["\u0161","s"],["\u0163","t"],["\u0165","t"],["\u0169","u"],["\u016B","u"],["\u016D","u"],["\u016F","u"],["\u0171","u"],["\u0173","u"],["\u0175","w"],["\u0177","y"],["\u017A","z"],["\u017C","z"],["\u017E","z"],["\u017F","s"],["\u01A1","o"],["\u01B0","u"],["\u01C6","dz"],["\u01C9","lj"],["\u01CC","nj"],["\u01CE","a"],["\u01D0","i"],["\u01D2","o"],["\u01D4","u"],["\u01D6","u"],["\u01D8","u"],["\u01DA","u"],["\u01DC","u"],["\u01DF","a"],["\u01E1","a"],["\u01E3","ae"],["\xE6","ae"],["\u01FD","ae"],["\u01E7","g"],["\u01E9","k"],["\u01EB","o"],["\u01ED","o"],["\u01EF","\u0292"],["\u01F0","j"],["\u01F3","dz"],["\u01F5","g"],["\u01F9","n"],["\u01FB","a"],["\u01FF","\xF8"],["\u0201","a"],["\u0203","a"],["\u0205","e"],["\u0207","e"],["\u0209","i"],["\u020B","i"],["\u020D","o"],["\u020F","o"],["\u0211","r"],["\u0213","r"],["\u0215","u"],["\u0217","u"],["\u0219","s"],["\u021B","t"],["\u021F","h"],["\u0227","a"],["\u0229","e"],["\u022B","o"],["\u022D","o"],["\u022F","o"],["\u0231","o"],["\u0233","y"],["\u02B0","h"],["\u02B1","h"],["\u0266","h"],["\u02B2","j"],["\u02B3","r"],["\u02B4","\u0279"],["\u02B5","\u027B"],["\u02B6","\u0281"],["\u02B7","w"],["\u02B8","y"],["\u02E0","\u0263"],["\u02E1","l"],["\u02E2","s"],["\u02E3","x"],["\u02E4","\u0295"],["\u0390","\u03B9"],["\u03AC","\u03B1"],["\u03AD","\u03B5"],["\u03AE","\u03B7"],["\u03AF","\u03B9"],["\u03B0","\u03C5"],["\u03CA","\u03B9"],["\u03CB","\u03C5"],["\u03CC","\u03BF"],["\u03CD","\u03C5"],["\u03CE","\u03C9"],["\u03D0","\u03B2"],["\u03D1","\u03B8"],["\u03D2","\u03A5"],["\u03D3","\u03A5"],["\u03D4","\u03A5"],["\u03D5","\u03C6"],["\u03D6","\u03C0"],["\u03F0","\u03BA"],["\u03F1","\u03C1"],["\u03F2","\u03C2"],["\u03F5","\u03B5"],["\u0439","\u0438"],["\u0450","\u0435"],["\u0451","\u0435"],["\u0453","\u0433"],["\u0457","\u0456"],["\u045C","\u043A"],["\u045D","\u0438"],["\u045E","\u0443"],["\u0477","\u0475"],["\u04C2","\u0436"],["\u04D1","\u0430"],["\u04D3","\u0430"],["\u04D7","\u0435"],["\u04DB","\u04D9"],["\u04DD","\u0436"],["\u04DF","\u0437"],["\u04E3","\u0438"],["\u04E5","\u0438"],["\u04E7","\u043E"],["\u04EB","\u04E9"],["\u04ED","\u044D"],["\u04EF","\u0443"],["\u04F1","\u0443"],["\u04F3","\u0443"],["\u04F5","\u0447"]];export default function Encoder(a={}){if(!(this instanceof Encoder))return new Encoder(...arguments);for(let b=0;b<arguments.length;b++)this.assign(arguments[b])}Encoder.prototype.assign=function(a){this.normalize=parse_option(a.normalize,!0,this.normalize);let b=a.include,c=b||a.exclude||a.split;if("object"==typeof c){let d=!b,e="";a.include||(e+="\\p{Z}"),c.letter&&(e+="\\p{L}"),c.number&&(e+="\\p{N}",d=!!b),c.symbol&&(e+="\\p{S}"),c.punctuation&&(e+="\\p{P}"),c.control&&(e+="\\p{C}"),(c=c.char)&&(e+="object"==typeof c?c.join(""):c),this.split=new RegExp("["+(b?"^":"")+e+"]+","u"),this.numeric=d}else this.split=parse_option(c,whitespace,this.split),this.numeric=parse_option(this.numeric,!0);if(this.prepare=parse_option(a.prepare,null,this.prepare),this.finalize=parse_option(a.finalize,null,this.finalize),normalize_mapper&&(this.mapper=new Map(normalize_mapper)),this.rtl=a.rtl||!1,this.dedupe=parse_option(a.dedupe,!0,this.dedupe),this.filter=parse_option((c=a.filter)&&new Set(c),null,this.filter),this.matcher=parse_option((c=a.matcher)&&new Map(c),null,this.matcher),this.mapper=parse_option((c=a.mapper)&&new Map(c),null,this.mapper),this.stemmer=parse_option((c=a.stemmer)&&new Map(c),null,this.stemmer),this.replacer=parse_option(a.replacer,null,this.replacer),this.minlength=parse_option(a.minlength,1,this.minlength),this.maxlength=parse_option(a.maxlength,0,this.maxlength),this.cache=c=parse_option(a.cache,!0,this.cache),c&&(this.timer=null,this.cache_size="number"==typeof c?c:2e5,this.cache_enc=new Map,this.cache_prt=new Map,this.cache_enc_length=128,this.cache_prt_length=128),this.matcher_str="",this.matcher_test=null,this.stemmer_str="",this.stemmer_test=null,this.matcher)for(const a of this.matcher.keys())this.matcher_str+=(this.matcher_str?"|":"")+a;if(this.stemmer)for(const a of this.stemmer.keys())this.stemmer_str+=(this.stemmer_str?"|":"")+a;return this},Encoder.prototype.addMatcher=function(a,b){return"object"==typeof a?this.addReplacer(a,b):2>a.length?this.addMapper(a,b):(this.matcher||(this.matcher=new Map),this.matcher.set(a,b),this.matcher_str+=(this.matcher_str?"|":"")+a,this.matcher_test=null,this.cache&&this.invalidate(),this)},Encoder.prototype.addStemmer=function(a,b){return this.stemmer||(this.stemmer=new Map),this.stemmer.set(a,b),this.stemmer_str+=(this.stemmer_str?"|":"")+a,this.stemmer_test=null,this.cache&&this.invalidate(),this},Encoder.prototype.addFilter=function(a){return this.filter||(this.filter=new Set),this.filter.add(a),this.cache&&this.invalidate(),this},Encoder.prototype.addMapper=function(a,b){return"object"==typeof a?this.addReplacer(a,b):1<a.length?this.addMatcher(a,b):(this.mapper||(this.mapper=new Map),this.mapper.set(a,b),this.cache&&this.invalidate(),this)},Encoder.prototype.addReplacer=function(a,b){return"string"==typeof a&&(a=new RegExp(a,"g")),this.replacer||(this.replacer=[]),this.replacer.push(a,b||""),this.cache&&this.invalidate(),this},Encoder.prototype.invalidate=function(){this.cache_enc.clear(),this.cache_prt.clear()},Encoder.prototype.encode=function(a){if(this.cache&&a.length<=this.cache_enc_length)if(!this.timer)this.timer=setTimeout(clear,0,this);else if(this.cache_enc.has(a))return this.cache_enc.get(a);this.normalize&&("function"==typeof this.normalize?a=this.normalize(a):normalize?a=a.normalize("NFKD").replace(normalize,"").toLowerCase():a=a.toLowerCase()),this.prepare&&(a=this.prepare(a)),this.numeric&&3<a.length&&(a=a.replace(numeric_split_prev_char,"$1 $2").replace(numeric_split_next_char,"$1 $2").replace(numeric_split_length,"$1 "));const b=!(this.dedupe||this.mapper||this.filter||this.matcher||this.stemmer||this.replacer);let c=[],d=this.split||""===this.split?a.split(this.split):a;for(let e,f,g=0;g<d.length;g++){if(!(e=f=d[g]))continue;if(e.length<this.minlength)continue;if(b){c.push(e);continue}if(this.filter&&this.filter.has(e))continue;if(this.cache&&e.length<=this.cache_prt_length)if(this.timer){const a=this.cache_prt.get(e);if(a||""===a){a&&c.push(a);continue}}else this.timer=setTimeout(clear,0,this);let a;if(this.stemmer&&2<e.length&&(this.stemmer_test||(this.stemmer_test=new RegExp("(?!^)("+this.stemmer_str+")$")),e=e.replace(this.stemmer_test,a=>this.stemmer.get(a)),a=1),this.matcher&&1<e.length&&(this.matcher_test||(this.matcher_test=new RegExp("("+this.matcher_str+")","g")),e=e.replace(this.matcher_test,a=>this.matcher.get(a)),a=1),e&&a&&(e.length<this.minlength||this.filter&&this.filter.has(e))&&(e=""),e&&(this.mapper||this.dedupe&&1<e.length)){let a="";for(let b,c,d=0,f="";d<e.length;d++)b=e.charAt(d),b===f&&this.dedupe||(c=this.mapper&&this.mapper.get(b),c||""===c?(c!==f||!this.dedupe)&&(f=c)&&(a+=c):a+=f=b);e=a}if(e&&this.replacer)for(let a=0;e&&a<this.replacer.length;a+=2)e=e.replace(this.replacer[a],this.replacer[a+1]);this.cache&&f.length<=this.cache_prt_length&&(this.cache_prt.set(f,e),this.cache_prt.size>this.cache_size&&(this.cache_prt.clear(),this.cache_prt_length=0|this.cache_prt_length/1.1)),e&&c.push(e)}return this.finalize&&(c=this.finalize(c)||c),this.cache&&a.length<=this.cache_enc_length&&(this.cache_enc.set(a,c),this.cache_enc.size>this.cache_size&&(this.cache_enc.clear(),this.cache_enc_length=0|this.cache_enc_length/1.1)),c};function clear(a){a.timer=null,a.cache_enc.clear(),a.cache_prt.clear()}